<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMeter - Trail</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        body { background-color: #f4f4f4; }
        .container { margin-top: 30px; }
        #map { height: 300px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">EcoMeter</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Services</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="trail.html">Trail</a></li>
                            <li><a class="dropdown-item" href="past-activities.html">Past Activities</a></li>
                            <li><a class="dropdown-item" href="battery-activity.html">Battery Activity</a></li>
                        </ul>
                    </li>
                </ul>
                <a href="contact.html" class="btn btn-outline-light">Contact Us</a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <h2 class="text-center">Trail - EV Journey Estimation</h2>
        <div class="row mt-4">
            <div class="col-md-6">
                <label for="battery-capacity-input">Battery Capacity (kWh):</label>
                <input type="number" id="battery-capacity-input" class="form-control" placeholder="Enter battery capacity">
                
                <label for="energy-consumption-input" class="mt-3">Energy Consumption (kWh/km):</label>
                <input type="number" id="energy-consumption-input" class="form-control" placeholder="Enter energy consumption">
                
                <label for="soc-input" class="mt-3">State of Charge (SoC %):</label>
                <input type="number" id="soc-input" class="form-control" placeholder="Enter state of charge">
                
                <label for="start" class="mt-3">Start Location:</label>
                <input type="text" id="start" class="form-control" placeholder="Enter start location">
                
                <label for="end" class="mt-3">End Location:</label>
                <input type="text" id="end" class="form-control" placeholder="Enter destination">
                
                <button class="btn btn-primary mt-3" onclick="calculateDistance()">Calculate Distance</button>

                <button class="btn btn-primary mt-3" onclick="recordtrip()">Record Trip</button>
            </div>
            <div class="col-md-6">
                <div id="map"></div>
            </div>
        </div>
        
        <div class="mt-4 p-3 bg-white shadow rounded">
            <h4>Travel Summary</h4>
            <p><strong>Distance:</strong> <span id="distance">Calculating...</span> km</p>
            <p><strong>Battery Capacity:</strong> <span id="battery-capacity">--</span> kWh</p>
            <p><strong>Energy Consumption:</strong> <span id="energy-consumption">--</span> kWh/km</p>
            <p><strong>State of Charge (SoC):</strong> <span id="soc">--</span>%</p>
            <p><strong>Energy Needed:</strong> <span id="energy-needed">--</span> kWh</p>
            <p><strong>Energy Available:</strong> <span id="energy-available">--</span> kWh</p>
            <p><strong>Status:</strong> <span id="status">--</span></p>
            <button id="charge-btn" class="btn btn-danger" style="display: none;" onclick="findChargingStations()">Find Charging Station</button>
        </div>
    </div>
    
    <script>
        async function getCoordinates(location) {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
            const data = await response.json();
            if (data.length > 0) {
                return { lat: data[0].lat, lon: data[0].lon };
            }
            return null;
        }
        
        async function calculateDistance() {
    let startLoc = document.getElementById('start').value;
    let endLoc = document.getElementById('end').value;
    let startCoords = await getCoordinates(startLoc);
    let endCoords = await getCoordinates(endLoc);

    if (!startCoords || !endCoords) {
        alert('Invalid location input. Please enter valid places.');
        return;
    }

    // Use the Haversine formula for accurate distance calculation
    let distance = haversineDistance(startCoords.lat, startCoords.lon, endCoords.lat, endCoords.lon);
    document.getElementById('distance').innerText = distance.toFixed(2);

    let batteryCapacity = parseFloat(document.getElementById('battery-capacity-input').value) || 50;
    let energyConsumption = parseFloat(document.getElementById('energy-consumption-input').value) || 0.2;
    let soc = parseFloat(document.getElementById('soc-input').value) || 80;

    // Corrected main formula
    let energyAvailable = (batteryCapacity * soc) / 100;
    let energyNeeded = distance * energyConsumption;

    document.getElementById('battery-capacity').innerText = batteryCapacity;
    document.getElementById('energy-consumption').innerText = energyConsumption;
    document.getElementById('soc').innerText = soc;
    document.getElementById('energy-needed').innerText = energyNeeded.toFixed(2);
    document.getElementById('energy-available').innerText = energyAvailable.toFixed(2);

    if (energyNeeded > energyAvailable) {
        document.getElementById('status').innerText = 'Need to Charge';
        document.getElementById('charge-btn').style.display = 'block';
    } else {
        document.getElementById('status').innerText = 'Enough Charge';
        document.getElementById('charge-btn').style.display = 'none';
    }
}

// Haversine formula to calculate distance between two latitude/longitude points
function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

        
        async function recordtrip() {
    const tripData = {
        start: document.getElementById("start").value,
        end: document.getElementById("end").value,
        distance: parseFloat(document.getElementById("distance").innerText),
        battery_capacity: parseFloat(document.getElementById("battery-capacity").innerText),
        energy_consumption: parseFloat(document.getElementById("energy-consumption").innerText),
        soc: parseFloat(document.getElementById("soc").innerText),
        energy_needed: parseFloat(document.getElementById("energy-needed").innerText),
        energy_available: parseFloat(document.getElementById("energy-available").innerText),
        status: document.getElementById("status").innerText
    };

    console.log(tripData); // Debugging: Check if data is being fetched properly

    const response = await fetch("http://127.0.0.1:5000/record_trip", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(tripData)
    });

    if (response.ok) {
        alert("Trip recorded successfully!");
    } else {
        alert("Failed to record trip.");
    }
}

        function findChargingStations() {
            window.open('https://www.google.com/maps/search/EV+Charging+Station', '_blank');
            let refills = parseInt(localStorage.getItem("refills")) || 0;
            refills += 1;
            localStorage.setItem("refills", refills);
            document.getElementById("refills").textContent = `${refills} times`;
        }

    </script>
</body>
</html>
